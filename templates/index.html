{% extends "base.html" %}

{% block title %}Dashboard - RollerCoin Bot{% endblock %}

{% block content %}
<div class="row">
    <!-- Status Card -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i data-feather="activity" class="me-2"></i>
                    Bot Status
                </h5>
                <span class="badge bg-{{ 'success' if status.running else 'secondary' }} status-badge">
                    {{ 'RUNNING (SIMULATION)' if status.running else 'STOPPED' }}
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-6">
                        <p class="mb-2">
                            <strong>Email:</strong><br>
                            <small class="text-muted">{{ status.email[:20] }}***</small>
                        </p>
                    </div>
                    <div class="col-sm-6">
                        <p class="mb-2">
                            <strong>Current Action:</strong><br>
                            <small class="text-muted" id="current-action">Loading...</small>
                        </p>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-sm-6">
                        <p class="mb-2">
                            <strong>Last Run:</strong><br>
                            <small class="text-muted">{{ status.last_run or 'Never' }}</small>
                        </p>
                    </div>
                    <div class="col-sm-6">
                        <p class="mb-2">
                            <strong>Total Runs:</strong><br>
                            <small class="text-muted" id="total-runs">{{ status.total_runs }}</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Card -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="bar-chart-2" class="me-2"></i>
                    Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="stat-item">
                            <h3 class="text-success mb-1" id="success-count">{{ status.total_runs - status.errors }}</h3>
                            <small class="text-muted">Successful Runs</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-item">
                            <h3 class="text-danger mb-1" id="error-count">{{ status.errors }}</h3>
                            <small class="text-muted">Errors</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-item">
                            <h3 class="text-info mb-1" id="uptime">
                                {% if status.running %}
                                    <i data-feather="check-circle" style="width: 24px; height: 24px;"></i>
                                {% else %}
                                    <i data-feather="x-circle" style="width: 24px; height: 24px;"></i>
                                {% endif %}
                            </h3>
                            <small class="text-muted">Status</small>
                        </div>
                    </div>
                </div>
                
                <div class="progress mt-3" style="height: 6px;">
                    {% set success_rate = ((status.total_runs - status.errors) / status.total_runs * 100) if status.total_runs > 0 else 100 %}
                    <div class="progress-bar bg-success" style="width: {{ success_rate }}%"></div>
                </div>
                <small class="text-muted">Success Rate: {{ "%.1f"|format(success_rate) }}%</small>
            </div>
        </div>
    </div>
</div>

<!-- Control Panel -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="settings" class="me-2"></i>
                    Control Panel
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="mb-3 mb-md-0">
                            Control your RollerCoin automation bot. Currently running in <span class="badge bg-info">SIMULATION MODE</span> - Start to begin automated login cycles, or stop to halt all operations.
                        </p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        {% if status.running %}
                            <form method="POST" action="{{ url_for('stop_bot') }}" class="d-inline">
                                <button type="submit" class="btn btn-danger btn-lg me-2">
                                    <i data-feather="stop-circle" class="me-2"></i>
                                    Stop Bot
                                </button>
                            </form>
                        {% else %}
                            <form method="POST" action="{{ url_for('start_bot') }}" class="d-inline">
                                <button type="submit" class="btn btn-success btn-lg me-2">
                                    <i data-feather="play-circle" class="me-2"></i>
                                    Start Bot
                                </button>
                            </form>
                        {% endif %}
                        
                        <a href="{{ url_for('logs') }}" class="btn btn-outline-secondary btn-lg">
                            <i data-feather="file-text" class="me-2"></i>
                            View Logs
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="user" class="me-2"></i>
                    Configuration
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('config') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">RollerCoin Email</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{{ status.email }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">RollerCoin Password</label>
                                <input type="password" class="form-control" id="password" name="password" 
                                       placeholder="Enter new password" required>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" {% if status.running %}disabled{% endif %}>
                        <i data-feather="save" class="me-2"></i>
                        Update Configuration
                    </button>
                    {% if status.running %}
                        <small class="text-muted ms-2">Stop the bot to update configuration</small>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh status every 5 seconds
    setInterval(updateStatus, 5000);
    
    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                // Update current action
                document.getElementById('current-action').textContent = data.current_action;
                
                // Update total runs
                document.getElementById('total-runs').textContent = data.total_runs;
                
                // Update error count
                document.getElementById('error-count').textContent = data.errors;
                
                // Update success count
                document.getElementById('success-count').textContent = data.total_runs - data.errors;
                
                // Update status badge
                const statusBadge = document.querySelector('.status-badge');
                if (data.running) {
                    statusBadge.textContent = 'RUNNING';
                    statusBadge.className = 'badge bg-success status-badge';
                } else {
                    statusBadge.textContent = 'STOPPED';
                    statusBadge.className = 'badge bg-secondary status-badge';
                }
            })
            .catch(error => console.error('Error updating status:', error));
    }
</script>
{% endblock %}
